<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JVM垃圾回收 | Long&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="Java后端技术博客,专注Java后端学习与总结。Java,Spring,SpringBoot,MyBatis,MySQL,设计模式,数据结构与算法,css3,html5,JavaScript,git,github等技术文章。">
    <meta name="keywords" content="Java后端技术博客,专注Java后端学习与总结。Java,Spring,SpringBoot,MyBatis,MySQL,设计模式,数据结构与算法,css3,html5,JavaScript,git,github等技术文章。">
    <meta name="baidu-site-verification" content="codeva-seF6ZEHK08">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.76b6ab0d.css" as="style"><link rel="preload" href="/assets/js/app.51feba23.js" as="script"><link rel="preload" href="/assets/js/2.7fde7eba.js" as="script"><link rel="preload" href="/assets/js/47.26520ab1.js" as="script"><link rel="prefetch" href="/assets/js/10.d4a40678.js"><link rel="prefetch" href="/assets/js/11.ef83cff0.js"><link rel="prefetch" href="/assets/js/12.383ef20e.js"><link rel="prefetch" href="/assets/js/13.f6363433.js"><link rel="prefetch" href="/assets/js/14.b0dc5477.js"><link rel="prefetch" href="/assets/js/15.1ec015a3.js"><link rel="prefetch" href="/assets/js/16.bb99988e.js"><link rel="prefetch" href="/assets/js/17.7023ec7b.js"><link rel="prefetch" href="/assets/js/18.cb8e1787.js"><link rel="prefetch" href="/assets/js/19.4b7745a6.js"><link rel="prefetch" href="/assets/js/20.1450178d.js"><link rel="prefetch" href="/assets/js/21.7bab5842.js"><link rel="prefetch" href="/assets/js/22.47397d69.js"><link rel="prefetch" href="/assets/js/23.7e0ab4dd.js"><link rel="prefetch" href="/assets/js/24.440e95d5.js"><link rel="prefetch" href="/assets/js/25.58ff2496.js"><link rel="prefetch" href="/assets/js/26.34aa4283.js"><link rel="prefetch" href="/assets/js/27.6c8fe645.js"><link rel="prefetch" href="/assets/js/28.299e5094.js"><link rel="prefetch" href="/assets/js/29.9e840626.js"><link rel="prefetch" href="/assets/js/3.8fa99732.js"><link rel="prefetch" href="/assets/js/30.c1ed3a92.js"><link rel="prefetch" href="/assets/js/31.b73a3cbe.js"><link rel="prefetch" href="/assets/js/32.36ca583c.js"><link rel="prefetch" href="/assets/js/33.02cd4a8a.js"><link rel="prefetch" href="/assets/js/34.cbf514e9.js"><link rel="prefetch" href="/assets/js/35.57db84a0.js"><link rel="prefetch" href="/assets/js/36.d7795327.js"><link rel="prefetch" href="/assets/js/37.8e55eb5a.js"><link rel="prefetch" href="/assets/js/38.cd5d6e54.js"><link rel="prefetch" href="/assets/js/39.81de13fd.js"><link rel="prefetch" href="/assets/js/4.4da6c226.js"><link rel="prefetch" href="/assets/js/40.344ec196.js"><link rel="prefetch" href="/assets/js/41.d6d6b7ca.js"><link rel="prefetch" href="/assets/js/42.10d39dbe.js"><link rel="prefetch" href="/assets/js/43.779ef0c0.js"><link rel="prefetch" href="/assets/js/44.b75f999a.js"><link rel="prefetch" href="/assets/js/45.fb2b2f01.js"><link rel="prefetch" href="/assets/js/46.055d1c40.js"><link rel="prefetch" href="/assets/js/48.d177a900.js"><link rel="prefetch" href="/assets/js/49.d2c38140.js"><link rel="prefetch" href="/assets/js/5.5b9c57b3.js"><link rel="prefetch" href="/assets/js/50.b0d323f8.js"><link rel="prefetch" href="/assets/js/51.2450d2fe.js"><link rel="prefetch" href="/assets/js/52.77813a39.js"><link rel="prefetch" href="/assets/js/53.c53568dc.js"><link rel="prefetch" href="/assets/js/54.3ed1ddb1.js"><link rel="prefetch" href="/assets/js/55.c7552084.js"><link rel="prefetch" href="/assets/js/56.52dd1f0c.js"><link rel="prefetch" href="/assets/js/57.8a5def51.js"><link rel="prefetch" href="/assets/js/58.2baf6d36.js"><link rel="prefetch" href="/assets/js/59.b8483b35.js"><link rel="prefetch" href="/assets/js/6.25058c75.js"><link rel="prefetch" href="/assets/js/60.40ea0ac8.js"><link rel="prefetch" href="/assets/js/61.79762a43.js"><link rel="prefetch" href="/assets/js/7.9afd6512.js"><link rel="prefetch" href="/assets/js/8.9abd3ee2.js"><link rel="prefetch" href="/assets/js/9.dc2b8faa.js">
    <link rel="stylesheet" href="/assets/css/0.styles.76b6ab0d.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="Long's blog" class="logo"> <span class="site-name can-hide">Long's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><!----> <span class="title" style="display:;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/se/" class="nav-link">JavaSE</a></li></ul></li><li class="dropdown-item"><h4>Spring</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/spring/" class="nav-link">Spring</a></li></ul></li><li class="dropdown-item"><h4>Java高级</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/jvm/" class="nav-link">JVM</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发工具" class="dropdown-title"><!----> <span class="title" style="display:;">开发工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/devtool/docker/" class="nav-link">Docker</a></li><li class="dropdown-item"><!----> <a href="/devtool/git/" class="nav-link">Git</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/hwlong019/theme-vdoing-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/avatar.jpg"> <div class="blogger-info"><h3>龙</h3> <span></span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><!----> <span class="title" style="display:;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/se/" class="nav-link">JavaSE</a></li></ul></li><li class="dropdown-item"><h4>Spring</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/spring/" class="nav-link">Spring</a></li></ul></li><li class="dropdown-item"><h4>Java高级</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/jvm/" class="nav-link">JVM</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发工具" class="dropdown-title"><!----> <span class="title" style="display:;">开发工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/devtool/docker/" class="nav-link">Docker</a></li><li class="dropdown-item"><!----> <a href="/devtool/git/" class="nav-link">Git</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/hwlong019/theme-vdoing-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/c4c12f/" class="sidebar-link">JVM内存结构</a></li><li><a href="/pages/a27a9f/" aria-current="page" class="active sidebar-link">JVM垃圾回收</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/a27a9f/#如何判断对象可以回收" class="sidebar-link">如何判断对象可以回收</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/a27a9f/#引用计数法" class="sidebar-link">引用计数法</a></li><li class="sidebar-sub-header level3"><a href="/pages/a27a9f/#可达性分析算法" class="sidebar-link">可达性分析算法</a></li><li class="sidebar-sub-header level3"><a href="/pages/a27a9f/#四中引用" class="sidebar-link">四中引用</a></li><li class="sidebar-sub-header level4"><a href="/pages/a27a9f/#强引用" class="sidebar-link">强引用</a></li><li class="sidebar-sub-header level4"><a href="/pages/a27a9f/#软引用-softreference" class="sidebar-link">软引用（SoftReference）</a></li><li class="sidebar-sub-header level4"><a href="/pages/a27a9f/#弱引用-weakreference" class="sidebar-link">弱引用（WeakReference）</a></li><li class="sidebar-sub-header level4"><a href="/pages/a27a9f/#虚引用-phantomreference" class="sidebar-link">虚引用（PhantomReference）</a></li><li class="sidebar-sub-header level4"><a href="/pages/a27a9f/#终结器引用-finalreference" class="sidebar-link">终结器引用（FinalReference）</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/a27a9f/#垃圾回收算法" class="sidebar-link">垃圾回收算法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/a27a9f/#标记清除" class="sidebar-link">标记清除</a></li><li class="sidebar-sub-header level3"><a href="/pages/a27a9f/#标记整理" class="sidebar-link">标记整理</a></li><li class="sidebar-sub-header level3"><a href="/pages/a27a9f/#复制" class="sidebar-link">复制</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/a27a9f/#分代垃圾回收" class="sidebar-link">分代垃圾回收</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/a27a9f/#相关vm参数" class="sidebar-link">相关VM参数</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/a27a9f/#垃圾回收器" class="sidebar-link">垃圾回收器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/a27a9f/#串行单线程" class="sidebar-link">串行单线程</a></li><li class="sidebar-sub-header level3"><a href="/pages/a27a9f/#吞吐量优先" class="sidebar-link">吞吐量优先</a></li><li class="sidebar-sub-header level3"><a href="/pages/a27a9f/#响应时间优先" class="sidebar-link">响应时间优先</a></li><li class="sidebar-sub-header level3"><a href="/pages/a27a9f/#g1" class="sidebar-link">G1</a></li><li class="sidebar-sub-header level4"><a href="/pages/a27a9f/#垃圾回收阶段" class="sidebar-link">垃圾回收阶段</a></li><li class="sidebar-sub-header level4"><a href="/pages/a27a9f/#full-gc" class="sidebar-link">Full GC</a></li><li class="sidebar-sub-header level4"><a href="/pages/a27a9f/#young-collection-跨代引用" class="sidebar-link">Young Collection 跨代引用</a></li><li class="sidebar-sub-header level4"><a href="/pages/a27a9f/#remark" class="sidebar-link">Remark</a></li><li class="sidebar-sub-header level4"><a href="/pages/a27a9f/#jdk-8u20-字符串去重" class="sidebar-link">JDK 8u20 字符串去重</a></li><li class="sidebar-sub-header level4"><a href="/pages/a27a9f/#jdk-8u40-并发标记类卸载" class="sidebar-link">JDK 8u40 并发标记类卸载</a></li><li class="sidebar-sub-header level4"><a href="/pages/a27a9f/#jdk-8u60-回收巨型对象" class="sidebar-link">JDK 8u60 回收巨型对象</a></li><li class="sidebar-sub-header level4"><a href="/pages/a27a9f/#jdk-9-并发标记起始时间的调整" class="sidebar-link">JDK 9 并发标记起始时间的调整</a></li><li class="sidebar-sub-header level4"><a href="/pages/a27a9f/#jdk-9-更高效的回收" class="sidebar-link">JDK 9 更高效的回收</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/a27a9f/#垃圾回收调优" class="sidebar-link">垃圾回收调优</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/a27a9f/#调优领域" class="sidebar-link">调优领域</a></li><li class="sidebar-sub-header level3"><a href="/pages/a27a9f/#确定目标" class="sidebar-link">确定目标</a></li><li class="sidebar-sub-header level3"><a href="/pages/a27a9f/#最快的-gc" class="sidebar-link">最快的 GC</a></li><li class="sidebar-sub-header level3"><a href="/pages/a27a9f/#新生代调优" class="sidebar-link">新生代调优</a></li><li class="sidebar-sub-header level3"><a href="/pages/a27a9f/#老年代调优" class="sidebar-link">老年代调优</a></li></ul></li></ul></li><li><a href="/pages/210bf9/" class="sidebar-link">JVM类加载与字节码</a></li><li><a href="/pages/971931/" class="sidebar-link">JVM类加载</a></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/java/jvm/#JVM" data-v-06225672>JVM</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/hwlong019" target="_blank" title="作者" class="beLink" data-v-06225672>龙</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-09-11</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">JVM垃圾回收<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="_02-jvm垃圾回收"><a href="#_02-jvm垃圾回收" class="header-anchor">#</a> 02.JVM垃圾回收</h1> <h2 id="如何判断对象可以回收"><a href="#如何判断对象可以回收" class="header-anchor">#</a> 如何判断对象可以回收</h2> <h3 id="引用计数法"><a href="#引用计数法" class="header-anchor">#</a> 引用计数法</h3> <ol><li>当一个对象被其他对象引用，该对象计数 +1，当某个对象不再引用该对象，其计数 -1</li> <li>当一个对象没有被其他对象引用时，即计数为0，该对象就可以被回收</li></ol> <p><strong>缺点</strong>：循环引用时，两个对象的计数都为1，导致两个对象都无法被释放</p> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/VcHgstzjRAMn_YGjQHT8K5N2kU0XSKK-qPjARmk-eEU.png" alt="image"></p> <h3 id="可达性分析算法"><a href="#可达性分析算法" class="header-anchor">#</a> 可达性分析算法</h3> <p>Java 虚拟机中的垃圾回收器采用可达性分析来探索所有存活的对象扫描堆中的对象，看是否能够沿着 GC Root对象 为起点的引用链找到该对象，找不到，表示可以回收。</p> <blockquote><p>首先确定根对象(肯定不能当成垃圾的被回收对象)，然后扫描堆，判断每个对象是否直接或间接被根对象引用，如果没有则回收。</p></blockquote> <p>可以作为GC Root的对象：</p> <ul><li><p>虚拟机栈（栈帧中的本地变量表）中引用的对象</p></li> <li><p>方法区中类静态属性引用的对象</p></li> <li><p>方法区中常量引用的对象</p></li> <li><p>本地方法栈中JNI（即一般说的Native方法）引用的对象</p></li> <li><p>所有被同步锁（synchronized关键字）持有的对象</p></li></ul> <h3 id="四中引用"><a href="#四中引用" class="header-anchor">#</a> 四中引用</h3> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/oh_xdmrnGacCQj62JfZFnYROTJo44eKSZ1mGHqpLVSs.png" alt="image"></p> <h4 id="强引用"><a href="#强引用" class="header-anchor">#</a> 强引用</h4> <ul><li>只有所有 GC Roots 对象都不通过【强引用】引用该对象，该对象才能被垃圾回收</li></ul> <blockquote><p>如上图的A1对象，可以沿着根对象(GC Root)找到的对象都是强引用对象，当C对象和B对象都不直接或间接引用A1对象时，才能被垃圾回收。</p></blockquote> <h4 id="软引用-softreference"><a href="#软引用-softreference" class="header-anchor">#</a> 软引用（SoftReference）</h4> <ul><li>仅有软引用引用该对象时，在垃圾回收后，<strong>内存仍不足</strong>时会再次出发垃圾回收，回收软引用对象</li> <li>可以配合引用队列来释放软引用自身</li></ul> <blockquote><p>如上图A2，C对象通过软引用，引用了A2对象，如果B对象没有强引用A2对象，<strong>在垃圾回收后，内存还是不够</strong>，A2对象会被回收</p></blockquote> <p>软引用基本使用(堆内存设置为：<code>-Xmx20m</code> ，查看GC详情：<code>-XX:+PrintGCDetails -verbose:gc</code> )：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">SoftReference</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;&gt;</span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 存</span>
    <span class="token class-name">SoftReference</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> ref <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoftReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SoftReference</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> ref <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 取，如果发生内存不足，这里取到的可能是null，因为被回收了</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ref<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>软引用+引用队列基本使用(堆内存设置为：<code>-Xmx20m</code> )：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">SoftReference</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;&gt;</span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 引用队列</span>
<span class="token class-name">ReferenceQueue</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 关联了引用队列，当软引用所关联的byte[]被回收时，软引用自己会加入到 queue 中去</span>
    <span class="token class-name">SoftReference</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> ref <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoftReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ref<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 从队列中获取第一个无用的 软引用对象，并移除</span>
<span class="token comment">// 因为队列先进先出，第一个出去后，第二个就是第一个</span>
<span class="token class-name">Reference</span><span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> poll <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>poll <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    list<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>poll<span class="token punctuation">)</span><span class="token punctuation">;</span>
    poll <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;===========================&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SoftReference</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> reference <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>reference<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h4 id="弱引用-weakreference"><a href="#弱引用-weakreference" class="header-anchor">#</a> 弱引用（WeakReference）</h4> <ul><li>仅有弱引用引用该对象时，在垃圾回收时，无论内存是否充足，都会回收弱引用对象</li> <li>可以配合引用队列来释放弱引用自身</li></ul> <blockquote><p>如上图A3，C对象通过弱引用，引用了A3对象，如果B对象没有强引用A3对象，<strong>在垃圾回收时</strong>，A3对象会被回收</p></blockquote> <p>弱引用基本使用(堆内存设置为：<code>-Xmx20m</code> )：</p> <p>弱引用与强引用类似，把 <code>SoftReference</code> 换成了 <code>WeakReference</code>  。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//  list --&gt; WeakReference --&gt; byte[]</span>
<span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">WeakReference</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;&gt;</span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">WeakReference</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> ref <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">WeakReference</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> w <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>w<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;循环结束：&quot;</span> <span class="token operator">+</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="虚引用-phantomreference"><a href="#虚引用-phantomreference" class="header-anchor">#</a> 虚引用（PhantomReference）</h4> <p>必须配合引用队列使用，主要配合 <code>ByteBuffffer</code> 使用，被引用对象回收时，会将虚引用入队，由 <code>Reference Handler</code> 线程调用虚引用相关方法释放<strong>直接内存</strong></p> <blockquote><p>如上图，B对象不再引用 <code>ByteBuffer</code> 对象，<code>ByteBuffer</code> 就会被回收。但是直接内存中的内存还未被回收。这时需要将虚引用对象 <code>Cleaner</code> 放入引用队列中，然后调用它的 <code>clean</code> 方法来释放直接内存。</p></blockquote> <h4 id="终结器引用-finalreference"><a href="#终结器引用-finalreference" class="header-anchor">#</a> 终结器引用（FinalReference）</h4> <p>无需手动编码，但其内部配合引用队列使用，在垃圾回收时，终结器引用入队（被引用对象暂时没有被回收），再由 <code>Finalizer</code> 线程通过终结器引用找到被引用对象并调用它的 <code>finalize</code> 方法，第二次 GC 时才能回收被引用对象</p> <blockquote><p>如上图，B对象不再引用A4对象。这时终结器对象就会被放入引用队列中，引用队列会根据它，找到它所引用的对象。然后调用被引用对象的finalize方法。调用以后，该对象就可以被垃圾回收了。因为执行finalize方法的线程优先级很低，所以效率很低，不容易被释放内存。</p></blockquote> <h2 id="垃圾回收算法"><a href="#垃圾回收算法" class="header-anchor">#</a> 垃圾回收算法</h2> <h3 id="标记清除"><a href="#标记清除" class="header-anchor">#</a> 标记清除</h3> <p>Mark Sweep，在虚拟机执行垃圾回收的过程中，先采用标记算法确定可回收对象，然后垃圾收集器根据标识清除相应的内容，给堆内存腾出相应的空间</p> <blockquote><p>这里的清除并不是将内存空间字节清零，而是记录这段内存的起始地址，下次分配内存的时候，会直接覆盖这段内存。</p></blockquote> <ul><li>速度较快</li> <li>会造成内存碎片，由于内存不连续，一旦分配较大内存的对象，会造成内存溢出问题</li></ul> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/erW0fczI1ZQKcXiHAdG8ixVhgT_exyhzV1zGnglxzfI.png" alt="image"></p> <h3 id="标记整理"><a href="#标记整理" class="header-anchor">#</a> 标记整理</h3> <p>Mark Compact，在虚拟机执行垃圾回收的过程中，先采用标记算法确定可回收对象，然后整理剩余的对象，将可用的对象移动到一起，使内存更加紧凑，连续的空间就更多。</p> <ul><li>速度慢</li> <li>没有内存碎片</li></ul> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/CYDXuk8ol_BQSJbiXhrno1weQtYyp0u89LHE7enNGe8.png" alt="image"></p> <h3 id="复制"><a href="#复制" class="header-anchor">#</a> 复制</h3> <p>Copy，将内存分为等大小的两个区域，FROM 和 TO。GC Root 引用的对象会被复制到 TO 中，再回收 FROM 中的对象，然后交换 FROM 和 TO 的内存地址，从而 TO 为空，供下次回收使用。</p> <ul><li>不会有内存碎片</li> <li>需要占用双倍内存空间</li></ul> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/kMqM0xcbBAoTLXmtlKcp4LhMk7YAFUpmVK7ZBpyjyLM.png" alt="image"></p> <h2 id="分代垃圾回收"><a href="#分代垃圾回收" class="header-anchor">#</a> 分代垃圾回收</h2> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/HIcQt4JhvzbqZrJEaUzKMwl5Eu_6MJqojac3aYAGEbg.png" alt="image"></p> <ol><li>对象首先分配在伊甸园区域</li> <li><strong>新生代(伊甸园)空间不足时，触发 Minor GC (小型垃圾回收)</strong></li></ol> <blockquote><ol><li>第一次回收：因为 FROM 中是空的，会将 伊甸园 中强引用的对象存放到 TO 中(垃圾回收复制算法)，并将 TO 中的对象“寿命”加1(说明存活了一次)，将 伊甸园 中的垃圾清空，最后交换 FROM 和 TO 的引用</li> <li>第二次回收：这一次是将 伊甸园 和 FROM 中的强引用的对象存入 TO 中，并将寿命加1，再清除 伊甸园 和 FROM 中的垃圾对象，最后交换 FROM 和 TO 的引用</li> <li>第N次回收：与第二次类似....</li></ol></blockquote> <ol start="3"><li>Minor GC 会引发 Stop The World，暂停其它用户的线程，等垃圾回收结束，用户线程才恢复运行</li> <li>当对象寿命超过阈值时(可能不用超过阈值)，会晋升至老年代，最大寿命是15（4bit，最大值就是 1111，10进制是15）</li> <li>当老年代空间不足，会先尝试触发 Minor GC，如果之后空间仍不足，触发 FULL GC，STW的时间更长</li></ol> <h3 id="相关vm参数"><a href="#相关vm参数" class="header-anchor">#</a> 相关VM参数</h3> <table><thead><tr><th>含义</th> <th>参数</th></tr></thead> <tbody><tr><td>堆初始大小</td> <td>-Xms</td></tr> <tr><td>堆最大大小</td> <td>-Xmx 或 -XX:MaxHeapSize=size</td></tr> <tr><td>新生代大小</td> <td>-Xmn 或 (-XX:NewSize=size + -XX:MaxNewSize=size )</td></tr> <tr><td>幸存区比例（动态）</td> <td>-XX:InitialSurvivorRatio=ratio 和 -XX:+UseAdaptiveSizePolicy</td></tr> <tr><td>幸存区比例</td> <td>-XX:SurvivorRatio=ratio</td></tr> <tr><td>晋升阈值</td> <td>-XX:MaxTenuringThreshold=threshold</td></tr> <tr><td>晋升详情</td> <td>-XX:+PrintTenuringDistribution</td></tr> <tr><td>GC详情</td> <td>-XX:+PrintGCDetails -verbose:gc</td></tr> <tr><td>FullGC 前 MinorGC</td> <td>-XX:+ScavengeBeforeFullGC</td></tr></tbody></table> <p>设置JVM参数：</p> <p><code>-Xms20M -Xmx20M -Xmn10M -XX:+UseSerialGC -XX:+PrintGCDetails -verbose:gc</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/ApA6_qcJS5W4RwLGird3lFsLYKyvaD2EmZs6WTEdQt4.png" alt="image"></p> <p>Minor GC：</p> <p>垃圾回收不是 Full GC 开头的话就是 Minor GC，不会清理老年代中的对象</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">7</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 7MB</span>
    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">512</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 512KB</span>
    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">512</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 512KB</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/dGAEhxLvTujQ0GQygtus6AF4NSC5xFa4ZvCGH1P3t-0.png" alt="image"></p> <p>大对象直接晋升老年代：</p> <p>当新生代空间不足，老年代空间足够，会将大对象直接晋升为老年代，不用触发垃圾回收</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">8</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 8MB</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/8sSY5BymFjnw7zeNnbhXR_uFVEjNhI4G8RYX_pI4Vok.png" alt="image"></p> <p>Full GC：</p> <p>Full GC 回收之后发现内存还是不足，就会报错</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">8</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 8MB</span>
    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">8</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 8MB</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/RHV8MVjwXsTMHKoBMAw_hNCaKYXgoukLMr0GQOk4ENQ.png" alt="image"></p> <p>多线程不会导致主线程崩溃：</p> <p>堆是共享的，当一个线程因为堆空间不足挂掉时，会立即释放堆空间内存，给其他线程使用</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">8</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 8MB</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">8</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 8MB</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;sleep....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/w1QEE7xqH9xkfAdjABJnm9WyR58MTUj4E3IwOdrIf04.png" alt="image"></p> <h2 id="垃圾回收器"><a href="#垃圾回收器" class="header-anchor">#</a> 垃圾回收器</h2> <p>相关概念：</p> <ul><li><strong>并行收集</strong>：指多条垃圾收集线程并行工作，但此时用户线程仍处于等待状态</li> <li><strong>并发收集</strong>：指用户线程与垃圾收集线程同时工作（不一定是并行的可能会交替执行）。用户程序在继续运行，而垃圾收集程序运行在另一个CPU上</li> <li><strong>吞吐量</strong>：即CPU用于运行用户代码的时间与CPU总消耗时间的比值（吞吐量 = 运行用户代码时间 / ( 运行用户代码时间 + 垃圾收集时间 )），例如：虚拟机共运行100分钟，垃圾收集器花掉1分钟，那么吞吐量就是99%</li></ul> <h3 id="串行单线程"><a href="#串行单线程" class="header-anchor">#</a> 串行单线程</h3> <p>堆内存较小，适合个人电脑</p> <blockquote><p>开启串行垃圾回收器：<code>-XX:+UseSerialGC = Serial + SerialOld</code>  ，新生代(Serial) ，老年代(SerialOld)</p></blockquote> <blockquote><p>新生代是复制算法，老年代是标记整理，两个分别执行，新生代内存不足时触发新生代的垃圾清理，老年代则触发老年代的。</p></blockquote> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/DJwNiL8CMrXg7tzFg2OqmRpbRW-7JnPFbpC68ltmLqQ.png" alt="image"></p> <ul><li><strong>安全点</strong>：让其他线程都在这个点停下来，以免垃圾回收时移动对象地址，使得其他线程找不到被移动的对象。</li> <li><strong>阻塞</strong>：因为是串行的，只有一个垃圾回收线程。且在该线程执行回收工作时，其他线程进入<strong>阻塞</strong>状态。</li></ul> <h3 id="吞吐量优先"><a href="#吞吐量优先" class="header-anchor">#</a> 吞吐量优先</h3> <p>多线程，堆内存较大，多核 cpu，<strong>【少餐多食】让单位时间内 STW 的时间最短</strong>， 0.2 0.2 = 0.4，垃圾回收时间占比最低，这样就称吞吐量高。</p> <ul><li><code>-XX:+UseParallelGC</code> ~ <code>-XX:+UseParallelOldGC</code>  ：开启吞吐量优先垃圾回收，JDK1.8及之后自动开启，开启其中一个，另一个也会被自动开启</li> <li><code>-XX:+UseAdaptiveSizePolicy</code>  ：新生代采用自适应大小的策略，动态调整 伊甸园 和 幸存区 的大小</li> <li><code>-XX:GCTimeRatio=ratio</code>  ：调整垃圾回收和总时间的占比(默认是99，一般设置19，1 / (1 + ratio)，如果ratio是99，虚拟机共运行100分钟，垃圾收集器花掉1分钟，那么吞吐量就是99%)</li> <li><code>-XX:MaxGCPauseMillis=ms</code>  ：每次垃圾回收最大暂停毫秒数(默认200毫秒)，和上面的冲突</li> <li><code>-XX:ParallelGCThreads=n</code>  ：控制 <code>ParallelGC</code>  运行垃圾回收的线程数，默认为 CPU 的核心数</li></ul> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/bxLwrCvGwvBuljmRIsynq26HJ4-rX2SrO7my42wkQEM.png" alt="image"></p> <h3 id="响应时间优先"><a href="#响应时间优先" class="header-anchor">#</a> 响应时间优先</h3> <p>多线程，堆内存较大，多核 cpu，<strong>【少食多餐】尽可能让单次 STW 的时间最短</strong>， 0.1 0.1 0.1 0.1 0.1 = 0.5</p> <ul><li><code>-XX:+UseConcMarkSweepGC</code> ~ <code>-XX:+UseParNewGC</code> ~ <code>SerialOld</code>  ：</li> <li><code>-XX:ParallelGCThreads=n</code> ~ <code>-XX:ConcGCThreads=threads</code>  ：</li> <li><code>-XX:CMSInitiatingOccupancyFraction=percent</code>  ：控制CMS垃圾清理的时机，比如设置80，在老年代内存占用到80%的时候，就触发垃圾回收(预留空间给浮动垃圾)</li> <li><code>-XX:+CMSScavengeBeforeRemark</code>  ：</li></ul> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/1Fu5128xxTHLIPYqFCBgq1W4YonMiB9L6gUM168zd9M.png" alt="image"></p> <ul><li>初始标记：标记 GC Roots 能直接到的对象。速度很快，存在Stop The World</li> <li>并发标记：进行 GC Roots Tracing 的过程，找出存活对象且用户线程可并发执行</li> <li>重新标记：为了修正并发标记期间因用户程序继续运行而导致标记产生变动的那一部分对象的标记记录。存在Stop The World</li> <li>并发清理：对标记的对象进行清除回收</li></ul> <h3 id="g1"><a href="#g1" class="header-anchor">#</a> G1</h3> <p>Garbage First，JDK 9以后默认使用，而且替代了CMS 收集器</p> <ul><li>2004 论文发布</li> <li>2009 JDK 6u14 体验</li> <li>2012 JDK 7u4 官方支持</li> <li>2017 JDK 9 默认</li></ul> <p>适用场景：</p> <ul><li>同时注重吞吐量（Throughput）和低延迟（Low latency），默认的暂停目标是 200 ms</li> <li>超大堆内存，会将堆划分为多个大小相等的 Region</li> <li>整体上是 标记+整理 算法，两个区域之间是 复制 算法</li></ul> <p>相关 JVM 参数：</p> <ul><li><code>-XX:+UseG1GC</code>  ：启动G1，JDK8默认是CMS</li> <li><code>-XX:G1HeapRegionSize=size</code></li> <li><code>-XX:MaxGCPauseMillis=time</code></li></ul> <h4 id="垃圾回收阶段"><a href="#垃圾回收阶段" class="header-anchor">#</a> 垃圾回收阶段</h4> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/sUYRWMGyZxAHqpTGP5u-INW_kALB1R-1b5s1HjUdHrA.png" alt="image"></p> <p>新生代伊甸园垃圾回收 –&gt; 内存不足，新生代回收+并发标记 –&gt; 混合收集，回收新生代伊甸园、幸存区、老年代内存 –&gt; 新生代伊甸园垃圾回收（重新开始）</p> <h5 id="young-collection"><a href="#young-collection" class="header-anchor">#</a> Young Collection</h5> <p>存在<strong>Stop The World</strong></p> <p><strong>分区算法region</strong>：分代是按对象的生命周期划分，分区则是将堆空间划分连续几个不同小区间，每一个小区间独立回收，可以控制一次回收多少个小区间，方便控制 GC 产生的停顿时间</p> <p>E：伊甸园，S：幸存区，O：老年代</p> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/Z9OqUNVgKQOLkJNk3-FOu5uqltZayL4DJdqG9iONA8o.png" alt="image"></p> <h5 id="young-collection-cm"><a href="#young-collection-cm" class="header-anchor">#</a> Young Collection + CM</h5> <ul><li>CM：并发标记</li> <li>在 Young GC 时会<strong>对 GC Root 进行初始标记</strong></li> <li>在老年代<strong>占用堆内存的比例</strong>达到阈值时，对进行并发标记（不会STW），阈值可以根据用户来进行设定</li></ul> <p><code>-XX:InitiatingHeapOccupancyPercent=percent</code> ：默认45%</p> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/YDqFFA4uFEpOg5lr3vbFA26GgvIfXM0PFI0HD-tPfj8.png" alt="image"></p> <h5 id="mixed-collection"><a href="#mixed-collection" class="header-anchor">#</a> Mixed Collection</h5> <p>会对 E、S、O 进行全面垃圾回收</p> <ul><li>最终标记（Remark）会 STW</li> <li>拷贝存活（Evacuation）会 STW</li></ul> <p><code>-XX:MaxGCPauseMillis=ms</code> ：用于指定最长的停顿时间</p> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/Y-Tlw74SEX3BSKnQwOs4yI0qTc0kKYLKSxXl9H4b8xk.png" alt="image"></p> <blockquote><p>为什么有的老年代被拷贝了，有的没拷贝？因为指定了最大停顿时间，如果对所有老年代都进行回收，耗时可能过高。为了保证时间不超过设定的停顿时间，会<strong>回收最有价值的老年代</strong>（回收后，能够得到更多内存）</p></blockquote> <h4 id="full-gc"><a href="#full-gc" class="header-anchor">#</a> Full GC</h4> <h5 id="serialgc"><a href="#serialgc" class="header-anchor">#</a> SerialGC</h5> <ul><li>新生代内存不足发生的垃圾收集 - minor gc</li> <li>老年代内存不足发生的垃圾收集 - full gc</li></ul> <h5 id="parallelgc"><a href="#parallelgc" class="header-anchor">#</a> ParallelGC</h5> <ul><li>新生代内存不足发生的垃圾收集 - minor gc</li> <li>老年代内存不足发生的垃圾收集 - full gc</li></ul> <h5 id="cms"><a href="#cms" class="header-anchor">#</a> CMS</h5> <ul><li>新生代内存不足发生的垃圾收集 - minor gc</li> <li>老年代内存不足</li> <li>(并发收集失败的时候会触发Full GC)</li></ul> <h5 id="g1-2"><a href="#g1-2" class="header-anchor">#</a> G1</h5> <ul><li>新生代内存不足发生的垃圾收集 - minor gc</li> <li>老年代内存不足</li> <li>(垃圾产生太快，并行标记和复制速度跟不上垃圾产生的速度，退化成串行收集，就会触发Full GC)</li></ul> <h4 id="young-collection-跨代引用"><a href="#young-collection-跨代引用" class="header-anchor">#</a> Young Collection 跨代引用</h4> <p>新生代回收的跨代引用（老年代引用新生代）问题</p> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/j8N4Lla5NoMvNU2VazjGkxInJHaY5NpJEHUrEzpvaSg.png" alt="image"></p> <p>老年代被划为一个个卡表(一个卡表大约为512K)，如果该区域引用了新生代对象，则该区域被称为脏卡。遍历对象是否被强引用时，就可以只关注脏卡的卡表，减少搜索范围，提高效率。</p> <ul><li>卡表与Remembered Set：Remembered Set 存在于E（新生代）中，用于保存新生代对象对应的脏卡</li> <li>在引用变更时通过post-write barried + dirty card queue (异步+队列完成脏卡的更新操作)</li> <li>concurrent refinement threads 更新 Remembered Set</li></ul> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/VZ4HvEsbepUDyEYf1fGKwKYYVzO3vIUOfuceNORymXI.png" alt="image"></p> <h4 id="remark"><a href="#remark" class="header-anchor">#</a> Remark</h4> <p>重新标记阶段，pre-write barrier + satb_mark_queue</p> <ul><li>黑色：已被处理，需要保留的</li> <li>灰色：正在处理中的</li> <li>白色：还未处理的</li></ul> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/gcvUxuPp4UfljwAJTiHoRaHoGlpX4BIfX5BM-ayHcSw.png" alt="image"></p> <ol><li>在并发标记过程中，有可能A被处理了以后未引用C，但该处理过程还未结束，在处理过程结束之前A引用了C，这时就会用到remark</li> <li>之前C未被引用，这时A引用了C，就会给C加一个写屏障，写屏障的指令会被执行，将C放入一个队列当中，并将C变为 处理中 状态</li> <li>在并发标记阶段结束以后，重新标记阶段会STW，然后将放在该队列中的对象重新处理，发现有强引用引用它，就会处理它</li></ol> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/5E7elEgN-QT1V9PAo3WAtdtTYn-fGDm7P1HqARs0XoM.png" alt="image"></p> <h4 id="jdk-8u20-字符串去重"><a href="#jdk-8u20-字符串去重" class="header-anchor">#</a> JDK 8u20 字符串去重</h4> <ul><li>优点：节省大量内存</li> <li>缺点：略微多占用了 cpu 时间，新生代回收时间略微增加</li></ul> <p><code>-XX:+UseStringDeduplication</code>  ：默认打开</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> s1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// char[]{'h','e','l','l','o'}</span>
<span class="token class-name">String</span> s2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// char[]{'h','e','l','l','o'}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>将所有新分配的字符串放入一个队列</li> <li>当新生代回收时，G1并发检查是否有字符串重复</li> <li>如果它们值一样，让它们引用同一个 char[]
<ul><li>与 String.intern() 不一样，String.intern() 关注的是字符串对象</li> <li>而字符串去重关注的是 char[]</li> <li>在 JVM 内部，使用了不同的字符串表</li></ul></li></ul> <h4 id="jdk-8u40-并发标记类卸载"><a href="#jdk-8u40-并发标记类卸载" class="header-anchor">#</a> JDK 8u40 并发标记类卸载</h4> <p>所有对象都经过并发标记后，就能知道哪些类不再被使用，当一个类加载器的所有类都不再使用，则卸载它所加载的所有类</p> <p><code>-XX:+ClassUnloadingWithConcurrentMark</code> ：默认启用</p> <h4 id="jdk-8u60-回收巨型对象"><a href="#jdk-8u60-回收巨型对象" class="header-anchor">#</a> JDK 8u60 回收巨型对象</h4> <p>一个对象大于 region 的一半时，称之为巨型对象</p> <ul><li>G1 不会对巨型对象进行拷贝，回收时被优先考虑</li> <li>G1 会跟踪老年代所有 incoming 引用，这样老年代 incoming 引用为0 的巨型对象就可以在新生代垃圾回收时处理掉</li></ul> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/DsKGhwT-QiHiBb0NkkoEz4IWmEjJo3Fe-SiWHUFfZig.png" alt="image"></p> <h4 id="jdk-9-并发标记起始时间的调整"><a href="#jdk-9-并发标记起始时间的调整" class="header-anchor">#</a> JDK 9 并发标记起始时间的调整</h4> <p>并发标记必须在堆空间占满前完成，否则退化为 FullGC</p> <ul><li>JDK 9 之前需要使用 <code>-XX:InitiatingHeapOccupancyPercent</code></li> <li>JDK 9 可以动态调整： <code>-XX:InitiatingHeapOccupancyPercent</code> 用来设置初始值，进行数据采样并动态调整，总会添加一个安全的空档空间</li></ul> <h4 id="jdk-9-更高效的回收"><a href="#jdk-9-更高效的回收" class="header-anchor">#</a> JDK 9 更高效的回收</h4> <ul><li>250+增强</li> <li>180+bug修复</li></ul> <p><a href="https://docs.oracle.com/en/java/javase/12/gctuning" target="_blank" rel="noopener noreferrer">https://docs.oracle.com/en/java/javase/12/gctuning<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="垃圾回收调优"><a href="#垃圾回收调优" class="header-anchor">#</a> 垃圾回收调优</h2> <ul><li>掌握 GC 相关的 VM 参数，会基本的空间调整</li> <li>掌握相关工具</li> <li>明白一点：调优跟应用、环境有关，没有放之四海而皆准的法则</li></ul> <h3 id="调优领域"><a href="#调优领域" class="header-anchor">#</a> 调优领域</h3> <ul><li>内存</li> <li>锁竞争</li> <li>cpu 占用</li> <li>io</li></ul> <h3 id="确定目标"><a href="#确定目标" class="header-anchor">#</a> 确定目标</h3> <ul><li>【低延迟】还是【高吞吐量】，选择合适的回收器</li> <li>CMS，G1，ZGC (低延迟)</li> <li>ParallelGC (高吞吐量)</li> <li>Zing</li></ul> <h3 id="最快的-gc"><a href="#最快的-gc" class="header-anchor">#</a> 最快的 GC</h3> <p>答案是不发生 GC</p> <p>查看 FullGC 前后的内存占用，考虑下面几个问题：</p> <ul><li>数据是不是太多？(比如一次从数据库查出很多数据)</li> <li>数据表示是否太臃肿？
<ul><li>对象图 (比如数据查询只查用到的数据)</li> <li>对象大小 (Object对象最小16字节，Integer对象大约24字节，int只有4字节)</li></ul></li> <li>是否存在内存泄漏？ (比如一个static Map只存数据不删除数据，可以使用软引用、弱引用、第三方缓存)</li></ul> <h3 id="新生代调优"><a href="#新生代调优" class="header-anchor">#</a> 新生代调优</h3> <p>新生代的特点：</p> <ul><li><p>所有的 new 操作的内存分配非常廉价 (每个线程都有个TLAB thread-local allocation buffffer区域，创建对象时，如果这里有内存，会现在这块区域存放对象)</p></li> <li><p>死亡对象的回收代价是零</p></li> <li><p>大部分对象用过即死</p></li> <li><p>Minor GC 的时间远远低于 Full GC</p></li></ul> <p>越大越好吗？</p> <p><code>-Xmn</code></p> <p>Sets the initial and maximum size (in bytes) of the heap for the young generation (nursery). GC is performed in this region more often than in other regions. If the size for the young generation is too small, then a lot of minor garbage collections are performed. If the size is too large, then only full garbage collections are performed, which can take a long time to complete. Oracle recommends that you keep the size for the young generation greater than 25% and less than 50% of the overall heap size.</p> <ul><li>新生代能容纳所有【并发量 * (请求-响应)】的数据</li> <li>幸存区大到能保留【当前活跃对象+需要晋升对象】</li> <li>晋升阈值配置得当，让长时间存活对象尽快晋升
<ul><li><code>-XX:MaxTenuringThreshold=threshold</code></li> <li><code>-XX:+PrintTenuringDistribution</code></li></ul></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Desired</span> survivor size <span class="token number">48286924</span> bytes<span class="token punctuation">,</span> <span class="token keyword">new</span> threshold <span class="token number">10</span> <span class="token punctuation">(</span>max <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token operator">-</span> age <span class="token number">1</span><span class="token operator">:</span> <span class="token number">28992024</span> bytes<span class="token punctuation">,</span> <span class="token number">28992024</span> total
<span class="token operator">-</span> age <span class="token number">2</span><span class="token operator">:</span> <span class="token number">1366864</span> bytes<span class="token punctuation">,</span> <span class="token number">30358888</span> total
<span class="token operator">-</span> age <span class="token number">3</span><span class="token operator">:</span> <span class="token number">1425912</span> bytes<span class="token punctuation">,</span> <span class="token number">31784800</span> total
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="老年代调优"><a href="#老年代调优" class="header-anchor">#</a> 老年代调优</h3> <p>以 CMS 为例</p> <ul><li>CMS 的老年代内存越大越好</li> <li>先尝试不做调优，如果没有 Full GC 那么已经...，否则先尝试调优新生代</li> <li>观察发生 Full GC 时老年代内存占用，将老年代内存预设调大 1/4 ~ 1/3
<ul><li><code>-XX:CMSInitiatingOccupancyFraction=percent</code></li></ul></li></ul></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/hwlong019/theme-vdoing-blog/edit/master/docs/10.JVM/02.JVM垃圾回收.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=Java" title="标签">#Java</a><a href="/tags/?tag=JVM" title="标签">#JVM</a></div> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/c4c12f/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">JVM内存结构</div></a> <a href="/pages/210bf9/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">JVM类加载与字节码</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/c4c12f/" class="prev">JVM内存结构</a></span> <span class="next"><a href="/pages/210bf9/">JVM类加载与字节码</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/cd7200/"><div>
            类与对象
            <!----></div></a> <span class="date">09-22</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/64fe6a/"><div>
            方法
            <!----></div></a> <span class="date">09-22</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/0143f0/"><div>
            包、权限修饰符
            <!----></div></a> <span class="date">09-22</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><!----> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2023-2023
    <span>Long | <a href="https://github.com/hwlong019/theme-vdoing-blog/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.51feba23.js" defer></script><script src="/assets/js/2.7fde7eba.js" defer></script><script src="/assets/js/47.26520ab1.js" defer></script>
  </body>
</html>
