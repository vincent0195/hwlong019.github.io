<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JVM内存结构 | Long&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="Java后端技术博客,专注Java后端学习与总结。Java,Spring,SpringBoot,MyBatis,MySQL,设计模式,数据结构与算法,css3,html5,JavaScript,git,github等技术文章。">
    <meta name="keywords" content="Java后端技术博客,专注Java后端学习与总结。Java,Spring,SpringBoot,MyBatis,MySQL,设计模式,数据结构与算法,css3,html5,JavaScript,git,github等技术文章。">
    <meta name="baidu-site-verification" content="codeva-seF6ZEHK08">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.76b6ab0d.css" as="style"><link rel="preload" href="/assets/js/app.51feba23.js" as="script"><link rel="preload" href="/assets/js/2.7fde7eba.js" as="script"><link rel="preload" href="/assets/js/46.055d1c40.js" as="script"><link rel="prefetch" href="/assets/js/10.d4a40678.js"><link rel="prefetch" href="/assets/js/11.ef83cff0.js"><link rel="prefetch" href="/assets/js/12.383ef20e.js"><link rel="prefetch" href="/assets/js/13.f6363433.js"><link rel="prefetch" href="/assets/js/14.b0dc5477.js"><link rel="prefetch" href="/assets/js/15.1ec015a3.js"><link rel="prefetch" href="/assets/js/16.bb99988e.js"><link rel="prefetch" href="/assets/js/17.7023ec7b.js"><link rel="prefetch" href="/assets/js/18.cb8e1787.js"><link rel="prefetch" href="/assets/js/19.4b7745a6.js"><link rel="prefetch" href="/assets/js/20.1450178d.js"><link rel="prefetch" href="/assets/js/21.7bab5842.js"><link rel="prefetch" href="/assets/js/22.47397d69.js"><link rel="prefetch" href="/assets/js/23.7e0ab4dd.js"><link rel="prefetch" href="/assets/js/24.440e95d5.js"><link rel="prefetch" href="/assets/js/25.58ff2496.js"><link rel="prefetch" href="/assets/js/26.34aa4283.js"><link rel="prefetch" href="/assets/js/27.6c8fe645.js"><link rel="prefetch" href="/assets/js/28.299e5094.js"><link rel="prefetch" href="/assets/js/29.9e840626.js"><link rel="prefetch" href="/assets/js/3.8fa99732.js"><link rel="prefetch" href="/assets/js/30.c1ed3a92.js"><link rel="prefetch" href="/assets/js/31.b73a3cbe.js"><link rel="prefetch" href="/assets/js/32.36ca583c.js"><link rel="prefetch" href="/assets/js/33.02cd4a8a.js"><link rel="prefetch" href="/assets/js/34.cbf514e9.js"><link rel="prefetch" href="/assets/js/35.57db84a0.js"><link rel="prefetch" href="/assets/js/36.d7795327.js"><link rel="prefetch" href="/assets/js/37.8e55eb5a.js"><link rel="prefetch" href="/assets/js/38.cd5d6e54.js"><link rel="prefetch" href="/assets/js/39.81de13fd.js"><link rel="prefetch" href="/assets/js/4.4da6c226.js"><link rel="prefetch" href="/assets/js/40.344ec196.js"><link rel="prefetch" href="/assets/js/41.d6d6b7ca.js"><link rel="prefetch" href="/assets/js/42.10d39dbe.js"><link rel="prefetch" href="/assets/js/43.779ef0c0.js"><link rel="prefetch" href="/assets/js/44.b75f999a.js"><link rel="prefetch" href="/assets/js/45.fb2b2f01.js"><link rel="prefetch" href="/assets/js/47.26520ab1.js"><link rel="prefetch" href="/assets/js/48.d177a900.js"><link rel="prefetch" href="/assets/js/49.d2c38140.js"><link rel="prefetch" href="/assets/js/5.5b9c57b3.js"><link rel="prefetch" href="/assets/js/50.b0d323f8.js"><link rel="prefetch" href="/assets/js/51.2450d2fe.js"><link rel="prefetch" href="/assets/js/52.77813a39.js"><link rel="prefetch" href="/assets/js/53.c53568dc.js"><link rel="prefetch" href="/assets/js/54.3ed1ddb1.js"><link rel="prefetch" href="/assets/js/55.c7552084.js"><link rel="prefetch" href="/assets/js/56.52dd1f0c.js"><link rel="prefetch" href="/assets/js/57.8a5def51.js"><link rel="prefetch" href="/assets/js/58.2baf6d36.js"><link rel="prefetch" href="/assets/js/59.b8483b35.js"><link rel="prefetch" href="/assets/js/6.25058c75.js"><link rel="prefetch" href="/assets/js/60.40ea0ac8.js"><link rel="prefetch" href="/assets/js/61.79762a43.js"><link rel="prefetch" href="/assets/js/7.9afd6512.js"><link rel="prefetch" href="/assets/js/8.9abd3ee2.js"><link rel="prefetch" href="/assets/js/9.dc2b8faa.js">
    <link rel="stylesheet" href="/assets/css/0.styles.76b6ab0d.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="Long's blog" class="logo"> <span class="site-name can-hide">Long's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><!----> <span class="title" style="display:;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/se/" class="nav-link">JavaSE</a></li></ul></li><li class="dropdown-item"><h4>Spring</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/spring/" class="nav-link">Spring</a></li></ul></li><li class="dropdown-item"><h4>Java高级</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/jvm/" class="nav-link">JVM</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发工具" class="dropdown-title"><!----> <span class="title" style="display:;">开发工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/devtool/docker/" class="nav-link">Docker</a></li><li class="dropdown-item"><!----> <a href="/devtool/git/" class="nav-link">Git</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/hwlong019/theme-vdoing-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/avatar.jpg"> <div class="blogger-info"><h3>龙</h3> <span></span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><!----> <span class="title" style="display:;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/se/" class="nav-link">JavaSE</a></li></ul></li><li class="dropdown-item"><h4>Spring</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/spring/" class="nav-link">Spring</a></li></ul></li><li class="dropdown-item"><h4>Java高级</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/jvm/" class="nav-link">JVM</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发工具" class="dropdown-title"><!----> <span class="title" style="display:;">开发工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/devtool/docker/" class="nav-link">Docker</a></li><li class="dropdown-item"><!----> <a href="/devtool/git/" class="nav-link">Git</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/hwlong019/theme-vdoing-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/c4c12f/" aria-current="page" class="active sidebar-link">JVM内存结构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/c4c12f/#程序计数器" class="sidebar-link">程序计数器</a></li><li class="sidebar-sub-header level2"><a href="/pages/c4c12f/#虚拟机栈" class="sidebar-link">虚拟机栈</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/c4c12f/#常见问题" class="sidebar-link">常见问题</a></li><li class="sidebar-sub-header level3"><a href="/pages/c4c12f/#栈内存溢出" class="sidebar-link">栈内存溢出</a></li><li class="sidebar-sub-header level3"><a href="/pages/c4c12f/#线程运行诊断" class="sidebar-link">线程运行诊断</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/c4c12f/#本地方法栈" class="sidebar-link">本地方法栈</a></li><li class="sidebar-sub-header level2"><a href="/pages/c4c12f/#堆" class="sidebar-link">堆</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/c4c12f/#堆内存溢出" class="sidebar-link">堆内存溢出</a></li><li class="sidebar-sub-header level3"><a href="/pages/c4c12f/#堆内存诊断" class="sidebar-link">堆内存诊断</a></li><li class="sidebar-sub-header level4"><a href="/pages/c4c12f/#jps-工具" class="sidebar-link">jps 工具</a></li><li class="sidebar-sub-header level4"><a href="/pages/c4c12f/#jmap-工具" class="sidebar-link">jmap 工具</a></li><li class="sidebar-sub-header level4"><a href="/pages/c4c12f/#jconsole-工具" class="sidebar-link">jconsole 工具</a></li><li class="sidebar-sub-header level4"><a href="/pages/c4c12f/#jvisualvm-工具" class="sidebar-link">jvisualvm 工具</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/c4c12f/#方法区" class="sidebar-link">方法区</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/c4c12f/#方法区内存溢出" class="sidebar-link">方法区内存溢出</a></li><li class="sidebar-sub-header level3"><a href="/pages/c4c12f/#运行时常量池" class="sidebar-link">运行时常量池</a></li><li class="sidebar-sub-header level3"><a href="/pages/c4c12f/#stringtable" class="sidebar-link">StringTable</a></li><li class="sidebar-sub-header level4"><a href="/pages/c4c12f/#常量池与串池的关系" class="sidebar-link">常量池与串池的关系</a></li><li class="sidebar-sub-header level4"><a href="/pages/c4c12f/#字符串变量拼接-1-8" class="sidebar-link">字符串变量拼接(1.8)</a></li><li class="sidebar-sub-header level4"><a href="/pages/c4c12f/#编译期优化" class="sidebar-link">编译期优化</a></li><li class="sidebar-sub-header level4"><a href="/pages/c4c12f/#字符串加载延迟" class="sidebar-link">字符串加载延迟</a></li><li class="sidebar-sub-header level4"><a href="/pages/c4c12f/#intern方法-1-8" class="sidebar-link">intern方法(1.8)</a></li><li class="sidebar-sub-header level4"><a href="/pages/c4c12f/#intern方法-1-6" class="sidebar-link">intern方法(1.6)</a></li><li class="sidebar-sub-header level4"><a href="/pages/c4c12f/#stringtable位置" class="sidebar-link">StringTable位置</a></li><li class="sidebar-sub-header level4"><a href="/pages/c4c12f/#stringtable垃圾回收" class="sidebar-link">StringTable垃圾回收</a></li><li class="sidebar-sub-header level4"><a href="/pages/c4c12f/#stringtable性能调优" class="sidebar-link">StringTable性能调优</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/c4c12f/#直接内存" class="sidebar-link">直接内存</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/c4c12f/#分配和回收原理" class="sidebar-link">分配和回收原理</a></li><li class="sidebar-sub-header level3"><a href="/pages/c4c12f/#禁用显式回收对直接内存的影响" class="sidebar-link">禁用显式回收对直接内存的影响</a></li></ul></li></ul></li><li><a href="/pages/a27a9f/" class="sidebar-link">JVM垃圾回收</a></li><li><a href="/pages/210bf9/" class="sidebar-link">JVM类加载与字节码</a></li><li><a href="/pages/971931/" class="sidebar-link">JVM类加载</a></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/java/jvm/#JVM" data-v-06225672>JVM</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/hwlong019" target="_blank" title="作者" class="beLink" data-v-06225672>龙</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-09-11</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">JVM内存结构<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="jvm内存结构"><a href="#jvm内存结构" class="header-anchor">#</a> JVM内存结构</h1> <p>Java Virtual Machine ，Java 程序的运行环境（Java 二进制字节码的运行环境）。</p> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/Yh6nu-f2cYcR-jg8_etLQteraVyp-vDTLdsYvhR3Guw.png" alt="image"></p> <p><strong>常见的 JVM：</strong></p> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/X8hLil_5Wcuh7l1Jbbv1ACosGyNv8yKL9YCJEpEgRqs.png" alt="image"></p> <p>来源维基百科：<a href="https://en.wikipedia.org/wiki/Comparison_of_Java_virtual_machines" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Comparison_of_Java_virtual_machines<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>学习路线：</strong></p> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/B7L8WPt_yGiHUuDyqx7v3Gs850d1vRN8OAsy4tpqesk.png" alt="image"></p> <p>参考资料：<a href="https://www.javainterviewpoint.com/java-virtual-machine-architecture-in-java/" target="_blank" rel="noopener noreferrer">https://www.javainterviewpoint.com/java-virtual-machine-architecture-in-java/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="程序计数器"><a href="#程序计数器" class="header-anchor">#</a> 程序计数器</h2> <p>Program Counter Register 程序计数器（是通过寄存器实现的），用于保存JVM中下一条所要执行的指令的地址。</p> <p>PC 寄存器用来存储指向下一条指令的地址，即将要执行的指令代码。由执行引擎读取下一条指令。</p> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/LDU5y0bDy6wMz_nqZCxe4l6m_74dubUnSXtcx5g8vlU.png" alt="image"></p> <blockquote><p>左边是二进制字节码，右边是Java编译后的代码，程序计数器就是用于记住下一条jvm指令的执行地址，比如现在是“0”，那他就会记住“3”，因为“3”在“0”的下面，而JVM会将指令 交给 解释器，解释器再将转为 机器码，交于CPU执行。</p></blockquote> <p>特点：</p> <ul><li><strong>是线程私有的</strong>：
<ul><li>CPU会为每个线程分配时间片，当当前线程的时间片使用完以后，CPU就会去执行另一个线程中的代码</li> <li>程序计数器是每个线程所私有的，当另一个线程的时间片用完，又返回来执行当前线程的代码时，通过程序计数器可以知道应该执行哪一句指令</li></ul></li> <li><strong>不会存在内存溢出</strong></li></ul> <h2 id="虚拟机栈"><a href="#虚拟机栈" class="header-anchor">#</a> 虚拟机栈</h2> <p>Java Virtual Machine Stacks (Java 虚拟机栈)，栈：先入后出</p> <ul><li>每个<strong>线程</strong>运行需要的内存空间，称为<strong>虚拟机栈</strong></li> <li>每个栈由多个<strong>栈帧</strong>组成，对应着每次方法调用时所占用的内存空间(参数、局部变量、返回地址)</li> <li>每个线程只能有一个<strong>活动栈帧</strong>，对应当前正在执行的那个方法</li></ul> <p>IDEA中的虚拟机栈：</p> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/QNjxxhHnySzcCvL9Lcq1KWdIkSvwSUaE7wBqpHe5NaE.png" alt="image"></p> <h3 id="常见问题"><a href="#常见问题" class="header-anchor">#</a> 常见问题</h3> <ol><li><strong>垃圾回收是否涉及栈内存？</strong></li></ol> <blockquote><p>不需要。因为虚拟机栈中是由一个个栈帧组成的，在方法执行完毕后，对应的栈帧就会被弹出栈。所以无需通过垃圾回收机制去回收内存。</p></blockquote> <ol start="2"><li><strong>栈内存分配越大越好吗？</strong></li></ol> <blockquote><p>不是。因为物理内存是一定的，栈内存越大，可以支持更多的递归调用，但是可执行的线程数就会越少。</p></blockquote> <blockquote><p>使用 <code>-Xss</code>  可以设置栈内存大小，比如物理内存是100Mb，当栈内存为1Mb时，可以同时有100个线程，而当栈内存为2Mb时，最多同时只有50个线程了。</p></blockquote> <ol start="3"><li><strong>方法内的局部变量是否线程安全？</strong></li></ol> <blockquote><p>如果方法内部局部变量没有逃离方法的作用访问，它是线程安全的</p></blockquote> <blockquote><p>如果是局部变量引用了对象，并逃离方法的范围，需要考虑线程安全问题</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> main1 <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
    <span class="token comment">//下面各个方法会不会造成线程安全问题？</span>

    <span class="token comment">//不会</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">m1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//会，可能会有其他线程使用这个对象</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">m2</span><span class="token punctuation">(</span><span class="token class-name">StringBuilder</span> sb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//会，其他线程可能会拿到这个线程的引用</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">StringBuilder</span> <span class="token function">m3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sb<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h3 id="栈内存溢出"><a href="#栈内存溢出" class="header-anchor">#</a> 栈内存溢出</h3> <p><code>Java.lang.stackOverflowError</code>：栈内存溢出</p> <p>导致栈内存溢出的情况：</p> <ul><li>栈帧过多导致栈内存溢出</li> <li>栈帧过大导致栈内存溢出</li></ul> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/qZ_LieS8dGV-uJQc_ZFfB85F9vhS8_4Om7uxKW-qL_Q.png" alt="image"></p> <h3 id="线程运行诊断"><a href="#线程运行诊断" class="header-anchor">#</a> 线程运行诊断</h3> <p>Linux环境下运行某些程序的时候，可能导致CPU的占用过高，使用 <code>top</code> 命令可以查看CPU的使用情况：</p> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/NRGswm6azDmf8mle_lxCwZbnNQ8NwdDKJxDSBKmzcZY.png" alt="image"></p> <p><code>ps H -eo pid,tid,%cpu | grep 进程id</code>  ，刚才通过top查到的进程号，用ps命令进一步定位是哪个线程引起的cpu占用过高：</p> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/Ntm7ihJ2tzT57YstweGBIebt4aZwhFFCRr_zaYvxc7k.png" alt="image"></p> <p><code>jstack 进程id</code> ，通过ps命令看到的tid来对比定位，注意jstack查找出的线程id是16进制的，需要转换</p> <p>这样就知道那个线程占用过多的CPU了，进一步定位到问题代码的源码行数</p> <p>还可以展示出死锁的信息</p> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/_P8_Uxq2AGWNPav20fTK6suWNC8pwGJWdLDH5kY_Jsg.png" alt="image"></p> <h2 id="本地方法栈"><a href="#本地方法栈" class="header-anchor">#</a> 本地方法栈</h2> <p>Native Method Stacks</p> <p>一些带有<strong>native关键字</strong>的方法就是需要JAVA去调用本地的C或者C++方法，因为JAVA有时候没法直接和操作系统底层交互，所以需要用到本地方法。</p> <h2 id="堆"><a href="#堆" class="header-anchor">#</a> 堆</h2> <p>Heap (堆)，通过<strong>new关键字创建的对象</strong>都会使用堆内存</p> <ul><li>它是<strong>线程共享</strong>的，堆中对象都需要考虑线程安全的问题</li> <li>有垃圾回收机制</li></ul> <h3 id="堆内存溢出"><a href="#堆内存溢出" class="header-anchor">#</a> 堆内存溢出</h3> <p><code>java.lang.OutofMemoryError ：java heap space</code> ：堆内存溢出</p> <p>设置堆空间大小： <code>-Xmx2m</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 演示堆内存溢出 java.lang.OutOfMemoryError: Java heap space
 * -Xmx8m ，最大堆空间的jvm虚拟机参数，默认是4g
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> main1 <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// new 一个list 存入堆中</span>
            <span class="token class-name">String</span> a <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 不断地向list 中添加 a</span>
                a <span class="token operator">=</span> a <span class="token operator">+</span> a<span class="token punctuation">;</span>
                i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// list 使用结束，被jc 垃圾回收</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="堆内存诊断"><a href="#堆内存诊断" class="header-anchor">#</a> 堆内存诊断</h3> <h4 id="jps-工具"><a href="#jps-工具" class="header-anchor">#</a> jps 工具</h4> <p>查看当前系统中有哪些 java 进程</p> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/EiL0FlQl9ppI5vGNUcnXpTbtyKrKpxEFTCydVhy3Ork.png" alt="image"></p> <h4 id="jmap-工具"><a href="#jmap-工具" class="header-anchor">#</a> jmap 工具</h4> <p>查看堆内存占用情况 <code>jmap - heap 进程id</code></p> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/k07qbKZItJjDDPiz-xzNcv2gdsyiLlrPHtRR8Pt5q3k.png" alt="image"></p> <h4 id="jconsole-工具"><a href="#jconsole-工具" class="header-anchor">#</a> jconsole 工具</h4> <p>图形界面的，多功能的监测工具，可以连续监测</p> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/v057DEHL8WLU1in4bwWEVf2n79wqFJa8p0eRlqZ5g1A.png" alt="image"></p> <h4 id="jvisualvm-工具"><a href="#jvisualvm-工具" class="header-anchor">#</a> jvisualvm 工具</h4> <p>可视化的展示虚拟机的内容</p> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/d3tk5VieSWT2kV8cJc7JcCBZkpffZ-b6y0-vT3LVPcs.png" alt="image"></p> <h2 id="方法区"><a href="#方法区" class="header-anchor">#</a> 方法区</h2> <p>方法区(Method Area) 是各个<strong>线程共享</strong>的内存区域，它用于存储已被虚拟机加载的类信息(比如class文件)、常量、静态变量、即时编译器编译后的代码等数据。（什么是类信息：<strong>类版本号、方法、接口</strong>。）</p> <p>官方对于方法区的定义：<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html" target="_blank" rel="noopener noreferrer">https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li>1.6是永久代实现，使用的堆内存</li> <li>1.8是元空间实现，使用的本地内存</li></ul> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/UBKi8CDNEKA4Eiucef-Hkwl4R_MISl4atonEK4HzL94.png" alt="image"></p> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/nIRBCKoqYSReisAnUiAwdhrWrOeIUKG8Dt_a1LXXdg0.png" alt="image"></p> <h3 id="方法区内存溢出"><a href="#方法区内存溢出" class="header-anchor">#</a> 方法区内存溢出</h3> <ul><li>1.8以前会导致永久代内存溢出 <code>java.lang.OutOfMemoryError: PermGen space</code> <ul><li>-XX:MaxPermSize=8m</li></ul></li> <li>1.8以后会导致元空间内存溢出 <code>java.lang.OutOfMemoryError: Metaspace</code> <ul><li>-XX:MaxMetaspaceSize=8m</li></ul></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 演示元空间内存溢出 java.lang.OutOfMemoryError: Metaspace
 * -XX:MaxMetaspaceSize=8m
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo1_8</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">{</span> <span class="token comment">// 可以用来加载类的二进制字节码</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Demo1_8</span> test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Demo1_8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">,</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// ClassWriter 作用是生成类的二进制字节码</span>
                <span class="token class-name">ClassWriter</span> cw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 版本号， public， 类名, 包名, 父类， 接口</span>
                cw<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span><span class="token constant">V1_8</span><span class="token punctuation">,</span> <span class="token class-name">Opcodes</span><span class="token punctuation">.</span><span class="token constant">ACC_PUBLIC</span><span class="token punctuation">,</span> <span class="token string">&quot;Class&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;java/lang/Object&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 返回 byte[]</span>
                <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> code <span class="token operator">=</span> cw<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 执行了类的加载</span>
                test<span class="token punctuation">.</span><span class="token function">defineClass</span><span class="token punctuation">(</span><span class="token string">&quot;Class&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> code<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> code<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Class 对象</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="运行时常量池"><a href="#运行时常量池" class="header-anchor">#</a> 运行时常量池</h3> <p><strong>常量池</strong>：就是一张表，虚拟机指令根据这张常量表找到要执行的类名、方法名、参数类型、字面量等信息</p> <p><strong>运行时常量池</strong>：常量池是 *.class 文件中的，<strong>当该类被加载，它的常量池信息就会放入运行时常量池，并把里面的符号地址变为真实地址</strong></p> <p>通过使用 javap 命令反编译 class 文件后，可以得到类的一些信息：</p> <p>常量池：</p> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/s4jAge3I-kRi_0_rfH-UYBcvS1aIGMFWuapuf4A1W0Q.png" alt="image"></p> <p>HelloWorld 方法：</p> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/zgwvaFxYpjkeO_n31ZBJr3Oy_7Q1MnjoCAqVbMXtZEA.png" alt="image"></p> <blockquote><p>系统会在HelloWorld方法反编译后得到的指令，去常量池中查找，比如第0条指令，后面是 <code>#2</code> ，则会在常量池中寻找，而常量池中的 <code>#2</code> 后面还有 <code>#6.#20</code>  也会依次寻找 <code>#6</code>  和 <code>#20</code> 。</p></blockquote> <h3 id="stringtable"><a href="#stringtable" class="header-anchor">#</a> StringTable</h3> <ul><li>常量池中的字符串仅是符号，第一次用到时才变为对象</li> <li>利用串池的机制，来避免重复创建字符串对象</li> <li>字符串变量拼接的原理是 StringBuilder（1.8）</li> <li>字符串常量拼接的原理是编译期优化</li> <li>可以使用 intern 方法，主动将串池中还没有的字符串对象放入串池
<ul><li>1.8 将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有则放入串池， 会把串池中的对象返回</li> <li>1.6 将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有会把此对象复制一份，放入串池，会把串池中的对象返回</li></ul></li></ul> <h4 id="常量池与串池的关系"><a href="#常量池与串池的关系" class="header-anchor">#</a> 常量池与串池的关系</h4> <p>常量池中的信息，都会被加载到运行时常量池中，这时的 a b ab 都还是常量池中的符号(没有成为java对象)，只有在被用到的时候(类似懒加载机制)，并且**串池(hashtable结构 不可扩容)**中不存在，才会被存入串池中。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> s1 <span class="token operator">=</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">;</span> 
<span class="token class-name">String</span> s2 <span class="token operator">=</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> s3 <span class="token operator">=</span> <span class="token string">&quot;ab&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/SQzO9E9Bl6wpnK0r4CytGQrC-DmeelL0ZyxNN00JrXM.png" alt="image"></p> <p>所以当这三行代码都执行了之后，**串池(StringTable)**中的数据应该为：<code>[&quot;a&quot;, &quot;b&quot;, &quot;ab&quot;]</code></p> <h4 id="字符串变量拼接-1-8"><a href="#字符串变量拼接-1-8" class="header-anchor">#</a> 字符串变量拼接(1.8)</h4> <p>字符串变量之间的拼接，底层使用的StringBuilder类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> s4 <span class="token operator">=</span> s1 <span class="token operator">+</span> s2<span class="token punctuation">;</span>   <span class="token comment">// new StringBuilder().append(&quot;a&quot;).append(&quot;b&quot;).toString()  new String(&quot;ab&quot;)</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s3 <span class="token operator">==</span> s4<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/cd3MzLnspoS_byl30Xz95bItbQ2pIOpoYqj-4K45bB0.png" alt="image"></p> <p>StringBuilder类的toString方法底层使用的是 <code>new String(xxx)</code> ，所以产生的对象是在堆中，而s3对象在串池中，所以 s3 和 s4 不相等。</p> <h4 id="编译期优化"><a href="#编译期优化" class="header-anchor">#</a> 编译期优化</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> s5 <span class="token operator">=</span> <span class="token string">&quot;a&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">;</span>  <span class="token comment">// javac 在编译期间的优化，结果已经在编译期确定为ab</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s3 <span class="token operator">==</span> s5<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// ture</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="images/zf8qRNl9F2KyGgEGR3RN8zK4bnskRTSai8wkMV65u3g.png" alt="image"></p> <p>这里也能看到 s3 和 s5 指向的都是 <code>#4</code>，因为 <code>&quot;a&quot;</code> + <code>&quot;b&quot;</code> 是确定的，编译的时候会直接变成 <code>&quot;ab&quot;</code> 。</p> <h4 id="字符串加载延迟"><a href="#字符串加载延迟" class="header-anchor">#</a> 字符串加载延迟</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 字符串个数 2256</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 字符串个数 2257</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 字符串个数 2258</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 字符串个数 2259</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 字符串个数 2260</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 字符串个数 2260</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 字符串个数 2260</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 字符串个数 2260</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 字符串个数 2260</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>字符串只有在被执行的时候，才会进入串池，如果串池中已经有了，就不会新添加。</p> <h4 id="intern方法-1-8"><a href="#intern方法-1-8" class="header-anchor">#</a> intern方法(1.8)</h4> <p>将字符串对象尝试放入串池，如果有则并不会放入，如果没有则放入串池，会把串池中的对象返回。</p> <ul><li>如果<strong>串池中没有</strong>这个字符串，将字符串对象放入串池，也就是说，放入的和返回的是<strong>同一个对象</strong></li> <li>如果<strong>串池中有</strong>这个字符串，就直接返回串池中的对象，准备放入串池的对象和返回的<strong>不是同一个对象</strong></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> x <span class="token operator">=</span> <span class="token string">&quot;ab&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 串池：ab,  a,  b</span>
<span class="token comment">// 堆：new String(&quot;a&quot;),  new String(&quot;b&quot;),  new String(&quot;ab&quot;)</span>

<span class="token class-name">String</span> s2 <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 因为ab已经在串池了，s对象放入串池失败，返回的s2是串池中的对象</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s2 <span class="token operator">==</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s <span class="token operator">==</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// false</span>

<span class="token comment">// 如果没有x变量，则 &quot;ab&quot; = s = s2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="intern方法-1-6"><a href="#intern方法-1-6" class="header-anchor">#</a> intern方法(1.6)</h4> <p>将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有会把此对象复制一份，放入串池，会把串池中的对象返回。</p> <blockquote><p>复制的对象和原对象不是同一个对象</p></blockquote> <ul><li>如果<strong>串池中没有</strong>这个字符串，将字符串对象复制一份，复制的对象和原来的对象内存地址值是不一样的，放入的和返回的<strong>不是同一个对象</strong></li> <li>如果<strong>串池中有</strong>这个字符串，就直接返回串池中的对象，准备放入串池的对象和返回的<strong>不是同一个对象</strong></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 串池：a,  b</span>
<span class="token comment">// 堆：new String(&quot;a&quot;),  new String(&quot;b&quot;),  new String(&quot;ab&quot;)</span>

<span class="token class-name">String</span> s2 <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// s 拷贝一份，放入串池</span>
<span class="token class-name">String</span> x <span class="token operator">=</span> <span class="token string">&quot;ab&quot;</span><span class="token punctuation">;</span>          <span class="token comment">// x 拿到的是串池中的对象</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s2 <span class="token operator">==</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// false</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s <span class="token operator">==</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// false</span>

<span class="token comment">// 如果是jdk1.8，则不会拷贝， s = s2 = x</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="stringtable位置"><a href="#stringtable位置" class="header-anchor">#</a> StringTable位置</h4> <ul><li>JDK1.6，StringTable是属于<strong>常量池</strong>的一部分。</li> <li>JDK1.8，StringTable是放在<strong>堆</strong>中的。</li></ul> <h4 id="stringtable垃圾回收"><a href="#stringtable垃圾回收" class="header-anchor">#</a> StringTable垃圾回收</h4> <p>StringTable在内存紧张时，会触发垃圾回收，回收那些没有被引用的字符串。</p> <h4 id="stringtable性能调优"><a href="#stringtable性能调优" class="header-anchor">#</a> StringTable性能调优</h4> <p>串池的底层用的是HashTable，数组+链表的数据结构</p> <p>使用 <code>-XX:+PrintStringTableStatistics</code>  参数可以打印串池的信息：</p> <div class="language-Plain Text line-numbers-mode"><pre class="language-plain"><code>StringTable statistics:
Number of buckets       :     60013 =    480104 bytes, avg   8.000
Number of entries       :    481491 =  11555784 bytes, avg  24.000
Number of literals      :    481491 =  29750584 bytes, avg  61.788
Total footprint         :           =  41786472 bytes
Average bucket size     :     8.023
Variance of bucket size :     8.084
Std. dev. of bucket size:     2.843
Maximum bucket size     :        23
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote><p>可以看到，默认的数组大小为 60013 个，串池中的字符串的数量为 481491 个。</p></blockquote> <p>如果系统中字符串用到的比较多的话，可以适当的将串池的数组长度调大：</p> <div class="language-Plain Text line-numbers-mode"><pre class="language-plain"><code>-XX:StringTableSize=桶个数
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>桶个数应在1009以上。</p></blockquote> <blockquote></blockquote> <blockquote><p><strong>当桶的个数变多时，Hash碰撞的几率就变小，链表的长度会变短，因为HashTable中的值是不重复的，链表变短后，校验字符串是否重复的时间会变短，从而提升效率。</strong></p></blockquote> <p>可以通过<strong>intern方法减少重复入池</strong>，保证相同的字符串在StringTable中只存储一份：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> address <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">BufferedReader</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token comment">/* 此处读取文件... */</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> line<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            line <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>line <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            address<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>line<span class="token comment">/*.intern()*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><blockquote><p>在这种情况下使用intern方法，占用内存的大小会比不使用intern方法占用内存的大小 小得多。</p></blockquote> <blockquote></blockquote> <blockquote><p>追溯到readLine底层，使用的是new String来构建字符串的，所以直接是存放在堆内存中，如果不使用intern方法，则所有的字符串对象都在堆内存中，而使用后剩余9次循环添加到集合的对象则是串池中的对象，理论上节约了十分之九的内存。</p></blockquote> <h2 id="直接内存"><a href="#直接内存" class="header-anchor">#</a> 直接内存</h2> <p>Direct Memory</p> <ul><li>常见于 NIO 操作时，用于数据缓冲区</li> <li>分配回收成本较高，但读写性能高</li> <li>不受 JVM 内存回收管理</li></ul> <p>普通的IO：</p> <blockquote><p>读入文件会先将文件放入系统的内存，再将文件放入Java的堆内存，Java才能读取，比较浪费时间、浪费性能。</p></blockquote> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/tv9d7mP4y8FdGDu1FC4IlYo9pPXKF3nCg3JqixYBYDA.png" alt="image"></p> <p>NIO：</p> <blockquote><p>开辟一块系统和Java都能访问到的内存区域，无需将文件再次缓冲到Java的堆内存当中，提高效率。</p></blockquote> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/Ffz7XWAgTAg0qiq0zU5pd6I2DcyHEL03t0dRm5Kr-Hc.png" alt="image"></p> <p>直接内存也会导致内存溢出，比如运行下面的代码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">int</span> _100Mb <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocateDirect</span><span class="token punctuation">(</span>_100Mb<span class="token punctuation">)</span><span class="token punctuation">;</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>可以看到下面的结果：</p> <p><img src="https://qaomuu-blog.oss-cn-hangzhou.aliyuncs.com/1YS2K6RSSE2l1nwuZvEnqSlfwTVBFHUbvhp5k5hq7Ww.png" alt="image"></p> <h3 id="分配和回收原理"><a href="#分配和回收原理" class="header-anchor">#</a> 分配和回收原理</h3> <p>直接内存的回收不是通过JVM的垃圾回收来释放的，而是通过 <code>unsafe.freeMemory()</code> 方法来手动释放</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span><span class="token class-name">Unsafe</span></span><span class="token punctuation">;</span>

<span class="token class-name">Unsafe</span> unsafe <span class="token operator">=</span> <span class="token function">getUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Java内部使用的对象，可以通过反射获取对象</span>
<span class="token comment">// 分配内存 1Gb = 1024 * 1024 * 1024</span>
<span class="token keyword">long</span> base <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">allocateMemory</span><span class="token punctuation">(</span>_1Gb<span class="token punctuation">)</span><span class="token punctuation">;</span>
unsafe<span class="token punctuation">.</span><span class="token function">setMemory</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 释放内存</span>
unsafe<span class="token punctuation">.</span><span class="token function">freeMemory</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>而NIO中的ByteBuffer类就是用到了该原理：</p> <ol><li>在DirectByteBuffer类(ByteBuffer的子类)的构造器中，使用了 <code>unsafe.allocateMemory(size)</code>  来获取内存空间</li> <li>ByteBuffer的实现类内部，使用了Cleaner(虚引用类型)对象来监测ByteBuffer对象是否被回收</li> <li>如果被回收，则会触发Cleaner对象的 <code>clean()</code> 方法</li> <li><code>clean()</code> 方法又会调用创建Cleaner时传入的Deallocator对象(该对象实现了Runnable接口，是一个单独的线程，用来调用 <code>unsafe.freeMemory(address)</code> 方法)</li></ol> <p>Demo：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocateDirect</span><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;分配完毕...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;开始释放...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
byteBuffer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 显式的垃圾回收，把byteBuffer对象回收掉，然后会自动触发Cleaner的clean()方法</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="禁用显式回收对直接内存的影响"><a href="#禁用显式回收对直接内存的影响" class="header-anchor">#</a> 禁用显式回收对直接内存的影响</h3> <p>可以使用 <code>-XX:+DisableExplicitGC</code> 命令来显式的禁用代码中的 <code>System.gc()</code> 作用(使用该方法影响性能，不光要回收新生代，还有老年代)。</p> <p>但是如果禁用掉，上面的Demo中的ByteBuffer对象则会长时间存在，程序占用的1Gb的直接内存也不会释放。</p> <p>此时，建议使用Unsafe类的 <code>freeMemory()</code> 方法手动释放直接内存。</p></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/hwlong019/theme-vdoing-blog/edit/master/docs/10.JVM/01.JVM内存结构.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=Java" title="标签">#Java</a><a href="/tags/?tag=JVM" title="标签">#JVM</a></div> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><!----> <a href="/pages/a27a9f/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">JVM垃圾回收</div></a></div> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/pages/a27a9f/">JVM垃圾回收</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/cd7200/"><div>
            类与对象
            <!----></div></a> <span class="date">09-22</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/64fe6a/"><div>
            方法
            <!----></div></a> <span class="date">09-22</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/0143f0/"><div>
            包、权限修饰符
            <!----></div></a> <span class="date">09-22</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><!----> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2023-2023
    <span>Long | <a href="https://github.com/hwlong019/theme-vdoing-blog/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.51feba23.js" defer></script><script src="/assets/js/2.7fde7eba.js" defer></script><script src="/assets/js/46.055d1c40.js" defer></script>
  </body>
</html>
